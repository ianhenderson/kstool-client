angular.module("KSTool",["ui.router","ngMaterial","ngSanitize"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,n,o){o.interceptors.push(["$q","$injector",function(t,n){return{responseError:function(o){return 403===o.status&&n.invoke(["AuthService",function(t){t.logout()}]),t.reject(o)}}}]),t.state("login",{url:"/login",templateUrl:"partials/login.html",controller:"LoginCtrl"}).state("nav",{"abstract":!0,templateUrl:"partials/nav.html",controller:"NavCtrl"}).state("nav.home",{url:"/home",templateUrl:"partials/home.html",controller:"HomeCtrl"}).state("nav.addwords",{url:"/addwords",templateUrl:"partials/add-words.html",controller:"AddWordsCtrl"}).state("nav.idea",{url:"/ideas/:id",templateUrl:"partials/idea.html",controller:"IdeaCtrl"}).state("nav.profile",{url:"/profile",templateUrl:"partials/profile.html",controller:"ProfileCtrl"}).state("nav.profile.user",{url:"/:id",templateUrl:"partials/profile.html",controller:"ProfileCtrl"}),n.otherwise("/home")}]).run(["$rootScope","$location","LocalStorage","AuthService",function(t,n,o,e){t.$on("$stateChangeStart",function(t,o,r,a,i){var l=e.validate();return l?void("login"!==o.name&&"login"!==a.name&&o.url||n.path("/home")):void e.logout()})}]).factory("LocalStorage",["$window",function(t){var n=t.localStorage;return service={set:function(t,o){return n.setItem(t,o)},get:function(t){return n.getItem(t)},remove:function(t){return n.removeItem(t)},clear:function(){return n.clear()}}}]).factory("AuthService",["$rootScope","$q","$window","$http","$state","$location","LocalStorage",function(t,n,o,e,r,a,i){return auth={simpleLogin:function(t,n){var o={method:"POST",url:"/api/login",data:{username:t,password:n}};return e(o).then(function(t){return i.set("userinfo",JSON.stringify(t.data)),a.path("/home"),t.data})["catch"](function(t){throw t.data})},signUp:function(t,n){var o={method:"POST",url:"/api/signup",data:{username:t,password:n}};return e(o).then(function(t){return i.set("userinfo",JSON.stringify(t.data)),t.data})["catch"](function(t){throw t.data})},signupAndLogin:function(t,n){return auth.signUp(t,n).then(function(o){return auth.simpleLogin(t,n)})["catch"](function(t){throw t})},superSignIn:function(t,n){return auth.simpleLogin(t,n)["catch"](function(o){return auth.signupAndLogin(t,n)})},validate:function(){var t=i.get("userinfo"),n=t&&JSON.parse(t).id;return n?(console.log("Logged in."),!0):(console.log("Not logged in."),!1)},logout:function(){var t={method:"POST",url:"/api/logout"};return e(t).then(function(t){return console.log("Logged out."),i.remove("userinfo"),r.go("login"),t.data})["catch"](function(t){return console.log("Error logging out: ",t),t.data})}}}]).factory("K",["$http","$q","LocalStorage",function(t,n,o){function e(n,o){n=n.replace(/\n+/g,"\n"),o&&(n=n.split(/\n/));var e={method:"POST",url:"/api/facts",data:{fact:n}};return t(e).then(function(t){return t.data})["catch"](function(t){return t.data})}function r(){var n={method:"GET",url:"/api/kanji"};return t(n).then(function(t){var n=i(t.data.kanji);return t.data.words=t.data.words.map(n),t.data})["catch"](function(t){return t.data})}function a(t){return['<span class="hl">',t,"</span>"].join("")}function i(t,n){return function(n){return n.replace(t,a(t))}}return K={addWord:e,getNextChar:r}}]).factory("Toast",["$mdToast",function(t){function n(n){t.show(t.simple().content(n).position("bottom"))}return n}]).controller("LoginCtrl",["$scope","AuthService","Toast",function(t,n,o){t.select=function(n){t.tabs.forEach(function(t){t.selected=t.title===n?!0:!1})},t.tabs=[{title:"Sign-in / Sign-up",action:n.superSignIn}],t.submit=function(){var n=t.tabs.filter(function(t){return t.selected===!0}).pop();n.action(t.username,t.password).then(function(t){console.log("Success: ",t)})["catch"](function(t){o(t)})}}]).controller("NavCtrl",["$scope","$state","$mdSidenav","AuthService",function(t,n,o,e){t.openLeftMenu=function(){o("left").toggle()},t.closeLeftMenu=function(){o("left").close()},t.navOptions=[{label:"Review Kanji",action:function(){n.go("nav.home"),o("left").close()}},{label:"Add Words",action:function(){n.go("nav.addwords"),o("left").close()}},{label:"Settings",action:function(){o("left").close()}},{label:"Sign Out",action:function(){e.logout(),o("left").close()}}]}]).controller("HomeCtrl",["$scope","K",function(t,n){t.getNextChar=function(){n.getNextChar().then(function(n){t.type=n})}}]).controller("AddWordsCtrl",["$scope","Toast","K",function(t,n,o){t.addWord=function(){var e=t.word;o.addWord(e,!0).then(function(o){t.word="",n(o)})}}]);